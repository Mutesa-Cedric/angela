name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

      - name: Create deploy script
        env:
          PROJECT_DIR: ${{ secrets.PROJECT_DIR }}
          DATA_DIR: ${{ secrets.DATA_DIR }}
          LOGS_DIR: ${{ secrets.LOGS_DIR }}
          CONTAINER_NAME: ${{ secrets.CONTAINER_NAME }}
          HOST_PORT: ${{ secrets.HOST_PORT }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
        run: |
          cat > /tmp/deploy.sh << SCRIPT
          #!/bin/bash
          set -e
          cd ${PROJECT_DIR}
          git pull origin main
          cd backend
          mkdir -p ${DATA_DIR}
          mkdir -p ${LOGS_DIR}
          docker build -t ${CONTAINER_NAME} .
          docker stop ${CONTAINER_NAME} || true
          docker rm ${CONTAINER_NAME} || true
          docker run -d -p ${HOST_PORT}:8000 -v ${DATA_DIR}:/app/data -v ${LOGS_DIR}:/app/logs --env-file ${ENV_FILE} --name ${CONTAINER_NAME} --restart unless-stopped ${CONTAINER_NAME}
          SCRIPT

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
        run: |
          scp -i ~/.ssh/deploy_key /tmp/deploy.sh ${VPS_USERNAME}@${VPS_HOST}:/tmp/deploy.sh
          ssh -i ~/.ssh/deploy_key ${VPS_USERNAME}@${VPS_HOST} "bash /tmp/deploy.sh"
